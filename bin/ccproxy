#!/bin/zsh

# ccproxy - Claude Command Proxy Script
# This script acts as a wrapper for the claude command, providing:
# - Dynamic provider configuration via JSON config file
# - Environment variable setup for Anthropic API authentication
# - Seamless passthrough of all arguments to the claude command
#
# Usage: ccproxy [options] [claude-args...]

# Default configuration file path
# Falls back to ~/.config/llm/cc-proxy.json if not specified via -c flag
CONFIG_FILE="$HOME/.config/llm/cc-proxy.json"

# Default provider name, can be overridden via CCPROXY_PROVIDER env var or -p flag
# Defaults to 'kimi' if no environment variable is set
DEFAULT_PROVIDER="${CCPROXY_PROVIDER:-kimi-sub}"
PROVIDER_NAME="$DEFAULT_PROVIDER"

# Parse command line arguments
# Supports:
# -c/--config: Specify custom config file path
# -p/--provider: Select provider from config file
# -h/--help: Show usage information
# All remaining arguments are passed to claude command
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--config)
            # Override default config file path with user-provided value
            CONFIG_FILE="$2"
            shift 2
            ;;
        -h|--help)
            # Display help message and exit
            echo "Usage: ccproxy [options] [claude-args...]"
            echo "Options:"
            echo "  -c, --config FILE    Use custom config file (default: ~/.config/llm/cc-proxy.json)"
            echo "  -p, --provider NAME  Provider key in config (default: $PROVIDER_NAME)"
            echo "  -h, --help           Show this help message"
            echo ""
            echo "Any additional arguments are passed directly to claude command"
            exit 0
            ;;
        -p|--provider)
            # Validate provider argument is not empty
            if [[ -z "$2" ]]; then
                echo "Error: --provider requires an argument"
                exit 1
            fi
            # Set provider name from command line argument
            PROVIDER_NAME="$2"
            shift 2
            ;;
        *)
            # Stop parsing options; remaining args will be passed to claude
            break
            ;;
    esac
done

# Configuration file validation and environment setup

# Verify config file exists before proceeding
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: Config file not found: $CONFIG_FILE"
    echo "Use -c/--config to specify a custom config file"
    exit 1
fi

# Check for required dependencies
# jq is needed to parse JSON config files
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed"
    exit 1
fi

# Validate that the specified provider exists in the config file
# Exits with error if provider key is not found
if ! jq -e --arg provider "$PROVIDER_NAME" '.[$provider]' "$CONFIG_FILE" > /dev/null; then
    echo "Error: Provider \"$PROVIDER_NAME\" not found in config: $CONFIG_FILE"
    exit 1
fi

# Export environment variables for claude command
# These variables are consumed by Claude Code to configure API access

# Authentication token for the API provider
export ANTHROPIC_AUTH_TOKEN=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].auth_key' "$CONFIG_FILE")

# Base URL for the API endpoint
export ANTHROPIC_BASE_URL=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].base_url' "$CONFIG_FILE")

# Primary model identifier for general use
export ANTHROPIC_MODEL=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].model' "$CONFIG_FILE")

# Optional: Smaller model for fast/efficient operations (deprecated, use ANTHROPIC_DEFAULT_HAIKU_MODEL)
# Uses jq's '// empty' to handle missing keys gracefully
SMALL_FAST_MODEL=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].small_model // empty' "$CONFIG_FILE")
if [[ -n "$SMALL_FAST_MODEL" ]]; then
    export ANTHROPIC_SMALL_FAST_MODEL="$SMALL_FAST_MODEL"
fi

# Model alias environment variables for fine-grained control
# These allow customization of what models the 'sonnet', 'opus', 'haiku' aliases resolve to

# Model for 'haiku' alias and background functionality
HAIKU_MODEL=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].ANTHROPIC_DEFAULT_HAIKU_MODEL // empty' "$CONFIG_FILE")
if [[ -n "$HAIKU_MODEL" ]]; then
    export ANTHROPIC_DEFAULT_HAIKU_MODEL="$HAIKU_MODEL"
fi

# Model for 'sonnet' alias (or 'opusplan' when not in plan mode)
SONNET_MODEL=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].ANTHROPIC_DEFAULT_SONNET_MODEL // empty' "$CONFIG_FILE")
if [[ -n "$SONNET_MODEL" ]]; then
    export ANTHROPIC_DEFAULT_SONNET_MODEL="$SONNET_MODEL"
fi

# Model for 'opus' alias (or 'opusplan' when in plan mode)
OPUS_MODEL=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].ANTHROPIC_DEFAULT_OPUS_MODEL // empty' "$CONFIG_FILE")
if [[ -n "$OPUS_MODEL" ]]; then
    export ANTHROPIC_DEFAULT_OPUS_MODEL="$OPUS_MODEL"
fi

# Model for subagents (used in Task tool with explore/implement subagents)
SUBAGENT_MODEL=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].CLAUDE_CODE_SUBAGENT_MODEL // empty' "$CONFIG_FILE")
if [[ -n "$SUBAGENT_MODEL" ]]; then
    export CLAUDE_CODE_SUBAGENT_MODEL="$SUBAGENT_MODEL"
fi

# Optional: Alternative API key field (currently disabled/commented out)
#export ANTHROPIC_API_KEY=$(jq -r --arg provider "$PROVIDER_NAME" '.[$provider].api_key' "$CONFIG_FILE")

# Execute claude command with all remaining arguments
# All arguments after options are passed directly to the claude command
claude "$@"
