#!/usr/bin/env python3
"""ccproxy - Claude Command Proxy Script

Acts as a wrapper for the claude command, providing:
- Dynamic provider configuration via JSON config files
- Environment variable setup for API authentication
- Quick provider switching via -P flag

Usage:
    ccproxy [options] -- [claude-args...]
    ccproxy list
"""

import argparse
import json
import os
import subprocess
import sys
from pathlib import Path


def run_claude(claude_args: list, env: dict) -> None:
    """Run claude, replacing the current process (exec)."""
    # Use execvpe to replace the python process with claude.
    # This ensures signals (Ctrl-C, SIGWINCH), TTY control, and I/O
    # are handled directly by claude without python interfering.
    try:
        os.execvpe("claude", ["claude"] + claude_args, env)
    except OSError as e:
        print(f"Error executing claude: {e}", file=sys.stderr)
        sys.exit(1)


# Default paths
CONFIG_DIR = Path.home() / ".config" / "ccproxy"
PROVIDERS_FILE = CONFIG_DIR / "providers.json"
CONFIG_FILE = CONFIG_DIR / "config.json"


def load_providers(providers_path: Path) -> dict:
    """Load providers configuration from JSON file."""
    if not providers_path.exists():
        print(f"Error: Providers file not found: {providers_path}", file=sys.stderr)
        sys.exit(1)

    with open(providers_path) as f:
        return json.load(f)


def load_config(config_path: Path) -> dict:
    """Load main configuration from JSON file."""
    if not config_path.exists():
        return {"default_provider": "deepseek"}

    with open(config_path) as f:
        return json.load(f)


def save_config(config_path: Path, config: dict) -> None:
    """Save main configuration to JSON file."""
    config_path.parent.mkdir(parents=True, exist_ok=True)
    with open(config_path, "w") as f:
        json.dump(config, f, indent=2)


def set_default_provider(config_path: Path, provider_name: str) -> None:
    """Set the default provider in config file."""
    config = load_config(config_path)
    config["default_provider"] = provider_name
    save_config(config_path, config)
    print(f"Default provider set to: {provider_name}")


def list_providers(providers: dict, current: str) -> None:
    """List all available providers."""
    print(f"Available providers in {PROVIDERS_FILE}:")
    print()

    for name, config in providers.items():
        marker = "*" if name == current else " "
        print(f"{marker} {name}")

        if name == current:
            print("  (current)")

        print(f"    Base URL: {config.get('base_url', 'N/A')}")
        print(f"    Model: {config.get('model', 'N/A')}")
        print()


def show_help(default_provider: str) -> None:
    """Display help message."""
    print("Usage: ccproxy [options] -- [claude-args...]")
    print("       ccproxy list")
    print()
    print("Commands:")
    print("  list                 List all available providers")
    print()
    print("Options:")
    print("  -P, --provider NAME  Provider key (default: %s)" % default_provider)
    print("  --default NAME       Set default provider")
    print("  -h, --help           Show this help message")
    print()
    print("Examples:")
    print("  ccproxy list                                    # List all providers")
    print("  ccproxy --default gemini                        # Set gemini as default")
    print("  ccproxy -P kimi -- -p 'Hello Claude'           # Use kimi provider")
    print("  ccproxy --provider deepseek -- --model opus    # Use deepseek provider")
    print()
    print("Note: Use '--' to separate ccproxy options from claude arguments")


def main():
    # Load configurations
    providers = load_providers(PROVIDERS_FILE)
    config = load_config(CONFIG_FILE)
    default_provider = config.get("default_provider", "deepseek")

    # Parse arguments
    parser = argparse.ArgumentParser(
        add_help=False,
        description="Claude Command Proxy - Switch Claude Code providers easily"
    )
    parser.add_argument(
        "-P", "--provider",
        default=default_provider,
        help="Provider name (default: %s)" % default_provider
    )
    parser.add_argument(
        "--default",
        dest="set_default",
        metavar="NAME",
        help="Set default provider"
    )
    parser.add_argument(
        "-h", "--help",
        action="store_true",
        help="Show help message"
    )
    parser.add_argument(
        "command",
        nargs="?",
        choices=["list"],
        help="Command to run"
    )
    parser.add_argument(
        "claude_args",
        nargs=argparse.REMAINDER,
        help="Arguments to pass to claude"
    )

    args, unknown = parser.parse_known_args()

    # Handle --default option
    if args.set_default:
        if args.set_default not in providers:
            print(f'Error: Provider "{args.set_default}" not found', file=sys.stderr)
            print("Available providers:", file=sys.stderr)
            for name in providers:
                print(f"  - {name}", file=sys.stderr)
            sys.exit(1)
        set_default_provider(CONFIG_FILE, args.set_default)
        sys.exit(0)

    # Handle help
    if args.help:
        show_help(default_provider)
        sys.exit(0)

    # Handle list command
    if args.command == "list":
        list_providers(providers, args.provider)
        sys.exit(0)

    # Validate provider
    provider_name = args.provider
    if provider_name not in providers:
        print(f'Error: Provider "{provider_name}" not found', file=sys.stderr)
        print("Available providers:", file=sys.stderr)
        for name in providers:
            print(f"  - {name}", file=sys.stderr)
        sys.exit(1)

    provider = providers[provider_name]

    # Build environment variables
    env = os.environ.copy()

    # Required variables
    if "auth_key" in provider:
        env["ANTHROPIC_AUTH_TOKEN"] = provider["auth_key"]
    if "api_key" in provider:
        env["ANTHROPIC_API_KEY"] = provider["api_key"]
    if "base_url" in provider:
        env["ANTHROPIC_BASE_URL"] = provider["base_url"]
    if "model" in provider:
        env["ANTHROPIC_MODEL"] = provider["model"]

    # Optional model aliases
    model_mappings = {
        "small_model": "ANTHROPIC_SMALL_FAST_MODEL",
        "ANTHROPIC_DEFAULT_HAIKU_MODEL": "ANTHROPIC_DEFAULT_HAIKU_MODEL",
        "ANTHROPIC_DEFAULT_SONNET_MODEL": "ANTHROPIC_DEFAULT_SONNET_MODEL",
        "ANTHROPIC_DEFAULT_OPUS_MODEL": "ANTHROPIC_DEFAULT_OPUS_MODEL",
        "CLAUDE_CODE_SUBAGENT_MODEL": "CLAUDE_CODE_SUBAGENT_MODEL",
    }

    for provider_key, env_key in model_mappings.items():
        if provider_key in provider and provider[provider_key]:
            env[env_key] = provider[provider_key]

    # Build claude arguments (handle -- separator)
    claude_args = args.claude_args
    if unknown and "--" in unknown:
        idx = unknown.index("--")
        claude_args = unknown[idx + 1:] + claude_args
    elif unknown:
        claude_args = unknown + claude_args

    # Execute claude command (wait for completion like shell scripts do)
    run_claude(claude_args, env)


if __name__ == "__main__":
    main()
