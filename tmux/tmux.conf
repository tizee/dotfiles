# docs see https://man7.org/linux/man-pages/man1/tmux.1.html
# Sever-Session-Window-Pane

# TMUX in TMUX {{{
# If running inside tmux ($TMUX is set), then change the status line to red
%if #{TMUX}
set -g status-bg red
%endif
# }}}

# BASIC OPTIONS {{{

# server option
# true color https://github.com/tmux/tmux/issues/1246
set-option -sa default-terminal "xterm-256color"
# set-option -ga terminal-overrides ",xterm-256color:Tc"

# Change the default $TERM to tmux-256color
#set -g default-terminal "tmux-256color"

# Enable RGB colour if running in xterm(1)
set-option -sa terminal-overrides ",xterm*:Tc"


# swtich to another available session when exiting the last terminal in tmux session
set-option -g detach-on-destroy off

# neovim 
set-option -sg escape-time 10
# history limit
set -g history-limit 5000
# Mouse mode
set -g mouse on

# Start window numbering at 1
set -g base-index 1
setw -g pane-base-index 1

# renumber window when a window closed
set -g renumber-windows on
# clock style
setw -g clock-mode-style 24

# window vim mode
setw -g mode-keys vi
# status line emcas mode
# set -g status-keys emcas

# window activity notifier
setw -g monitor-activity on
set -g visual-activity on

# resize
setw -g aggressive-resize on

# for using vim-gitgutter
set -g focus-events on

# Window settings
set-window-option -g automatic-rename on
set-option -g set-titles on
set -g set-titles-string "#I:#W"

# fix path
bind '%' split-window -h -c '#{pane_current_path}'
bind '"' split-window -v -c '#{pane_current_path}' 
bind c new-window -c '#{pane_current_path}'

# }}}

# KEY MAPPINGS {{{

# Link window
bind L command-prompt -p "Link window from (session:window): " "link-window -s %% -a"
# Move window to
# Move window from
# Move pane to
# Move pane from

# use tty-clock
unbind-key t 
bind-key t send-keys "tty-clock -c" Enter

# remap prefix from 'C-b' to 'C-a'
unbind-key C-b
unbind-key C-a
set-option -g prefix C-a
bind-key -r C-a send-prefix

# list key-bindings
bind-key -n C-k list-keys

# reload 
bind r source-file ~/.tmux.conf \; display-message "tmux config reloaded."
# Split
bind V split-window -h
bind H split-window -v

# layouts
bind D source-file ~/.tmux/tmux_scripts/hsplit
bind E source-file ~/.tmux/tmux_scripts/vsplit
bind-key S source-file ~/.tmux/tmux_scripts/update_session_path
 
# Some extra key bindings to select higher numbered windows
bind F1 selectw -t:10
bind F2 selectw -t:11
bind F3 selectw -t:12
bind F4 selectw -t:13
bind F5 selectw -t:14
bind F6 selectw -t:15
bind F7 selectw -t:16
bind F8 selectw -t:17
bind F9 selectw -t:18
bind F10 selectw -t:19
bind F11 selectw -t:20
bind F12 selectw -t:21

# open in alacritty
bind C run-shell -b 'alacritty --working-directory #{pane_current_path} -e tmux'

# reload (conflict with vim)
# bind C-r source-file ~/.tmux.conf \; display "Refleshed Configure!"

# HOOKS {{{
unbind-key O 
bind O show-hooks -g  # show all hooks
# set-hook client-attached display-message "ðŸš§ Connect âœ…"
# set-hook -g session-created 'clock-mode -t 1'
# set-hook -g window-linked 'selectw -n clock-mode -t 1'
# set-hook -g after-split-window 'selectl even-vertical'

# }}}

# MOVE AROUND {{{
# bind-key S new-session '#{sessin_path}'
# resize
bind H resize-pane -L 5
bind J resize-pane -D 5
bind K resize-pane -U 5
bind L resize-pane -R 5
# combine with Meta key
bind-key M-h resize-pane -L 5
bind-key M-j resize-pane -D 5
bind-key M-k resize-pane -U 5
bind-key M-l resize-pane -R 5

# hjkl pane traversal
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# use -n to avoid prefix
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

bind -n M-Left  select-pane -L
bind -n M-Down select-pane -D
bind -n M-Up select-pane -U
bind -n M-Right select-pane -R

# swap pane
bind > swap-pane -D       # swap current pane with the next one
bind < swap-pane -U       # swap current pane with the previous one

# Shift arrow to switch windows
bind -n S-Left previous-window
bind -n S-Right next-window

# easier and faster switching between next/prev window
bind C-p previous-window
bind C-n next-window
# }}}

# COPY MODE {{{
# enter copy mode
bind Enter copy-mode
set-option -ga terminal-overrides ",xterm-256color:Tc"

# vim copy to system clipboard
if-shell '[[ $(uname -s) = Linux ]]' { 
   bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -in -selection clipboard" 
} { 
   bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy" 
}
# }}}

# Switch Session
# use default prefix-s

# tmux attach default session
# new-session -n $HOST

# Keys to toggle monitoring activity in a window and the synchronize-panes option
bind m set monitor-activity
bind y set synchronize-panes\; display 'synchronize-panes #{?synchronize-panes,on,off}'

# }}}

# PLUGINS {{{

# TPM 

# TODO: add local tmux package install support
set -g @plugin 'tmux-plugins/tpm'

# prefix + I  fetch and install plugins
# prefix + U  update plugins
# prefix + alt + u remove comment out plugins

# plugins {{{
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tizee/tmux-osinfo'
set -g @plugin 'tizee/tmux-plugin-sysstat'
set -g @plugin 'tizee/tmux-net-speed'
set -g @plugin 'tizee/tmux-online-status'
# }}}

# tmux-resurrect {{{

# }}}

# }}}

# UI {{{

# Colors {{{

# Dracula
color_white='#f8f8f2'
color_gray='#44475a'
color_dark_gray='#282a36'
color_light_purple='#bd93f9'
color_dark_purple='#6272a4'
color_cyan='#8be9fd'
color_green='#50fa7b'
color_orange='#ffb86c'
color_red='#ff5555'
color_pink='#ff79c6'
color_yellow='#f1fa8c'
color_lightblue='#a3d8f4'
color_lightpink='#fcdada'

# semantic names
color_dark="$color_dark_gray"
color_light="$color_white"
color_session_text="$color_white"
color_status_text="$color_light_purple"
color_main="$color_orange"
color_secondary="$color_pink"

color_bar_bg="$color_gray"
color_tab_active_bg="$color_dark_gray"
color_tab_active_fg="$color_secondary"

color_level_ok="$color_green"
color_level_warn="$color_yellow"
color_level_stress="$color_red"
color_window_off_indicator="colour088"
color_window_off_status_bg="colour238"
color_window_off_status_current_bg="colour254"

# }}}

# Status Bar General Settings {{{

set -g status on 
set -g status-interval 5 # refresh every 5 seconds 
set -g status-position top # top/bottom(default)
set -g status-justify left # left/ center/ right
set -g status-left-length '200'
set -g status-right-length '100'

set -g mode-style "fg=$color_green,bg=$color_gray"

# command line style
set -g message-style "fg=$color_cyan,bg=$color_dark"

# status line style
set -g status-style "fg=$color_cyan,bg=$color_bar_bg"

# when window has monitoring notification
setw -g window-status-activity-style "fg=$color_cyan"

# outline for active pane
setw -g pane-active-border-style "fg=$color_cyan"


# slant
sep_left="î‚¼"
sep_right="î‚¾"
sep_left_bottom="î‚¸"
sep_right_bottom="î‚º"
bar_sep_left="î‚²"
bar_sep_right="î‚°"
setw -g window-status-format " #I #W "
setw -g window-status-current-style "fg=$color_tab_active_fg,bold,bg=$color_tab_active_bg"
setw -g window-status-current-format "#[fg=$color_bar_bg]$bar_sep_right#[default] #I #W #[fg=$color_tab_active_bg,bg=$color_bar_bg]$bar_sep_right#[default]"

# }}}

# Status Bar {{{

# current session
bar_session="#[fg=$color_red,bg=$color_yellow] #{host} #[default]#[bg=$color_white,fg=$color_gray] ï¬¦ #S #[default]"
# bar_battery=

# 
bar_date="#[fg=$color_lightblue]$sep_right #[default]#[fg=$color_dark_gray,bg=$color_lightblue]%a %h %d %H:%M#[default]#[fg=$color_lightblue]$sep_left_bottom #[default]"
bar_zoom_flag="#[fg=$color_secondary,bg=$color_bar_bg]#{?window_zoomed_flag,[Z],}#[default]"

# tmux-prefix-highlight {{{
set -g @prefix_highlight_fg 'colour154' # default is 'colour231'
set -g @prefix_highlight_bg '$color_bar_bg'  # default is 'colour04'
set -g @prefix_highlight_output_prefix '< '
set -g @prefix_highlight_output_suffix ' >'
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr 'fg=colour154,bg=$color_bar_bg,bold'
set -g @prefix_highlight_prefix_prompt 'PREFIX'
set -g @prefix_highlight_copy_prompt 'COPY'
# }}}

# tmux-plugin-systat{{{
# cpu template
set -g @sysstat_cpu_view_tmpl 'C:#[fg=#{cpu.color}]#{cpu.pused}%#[default]'
set -g @sysstat_cpu_color_low "$color_level_ok"
set -g @sysstat_cpu_color_medium "$color_level_warn"
set -g @sysstat_cpu_color_stress "$color_level_stress"
# # memory
# # #{mem.used}
set -g @sysstat_mem_view_tmpl ' M:#[fg=#{mem.color}]#{mem.pused}%#[default]'
set -g @sysstat_mem_color_low "$color_level_ok"
set -g @sysstat_mem_color_medium "$color_level_warn"
set -g @sysstat_mem_color_stress "$color_level_stress"

bar_sysstat="#{sysstat_cpu} #{sysstat_mem}"

#}}}

# tmux-net-speed {{{
set -g @download_speed_format "#[fg=$color_white,bg=$color_light_purple]%4s"
set -g @upload_speed_format "#[fg=$color_white,bg=$color_light_purple]%4s"
set -g @net_speed_format "D:%3s U:%3s"
bar_network="#[fg=$color_light_purple]$sep_right #[default]#[fg=$color_white,bg=$color_light_purple]ï›™ #{download_speed} #[fg=$color_white,bg=$color_light_purple]ï©‘#[default]#[default]#{upload_speed} #{online_status}#[fg=$color_light_purple]$sep_left_bottom#[default]"
# }}}

# tmux-online-status {{{
set -g @offline_icon "#[fg=$color_red,bg=$color_light_purple]ï™š #[default]"
set -g @online_icon "#[fg=$color_green,bg=$color_light_purple]ï”‚ #[default]"
set -g @ping_timeout 3
set -g @route_to_ping "cn.bing.com"

# }}}

# tmux-osinfo {{{
set -g @custom_opsystem_icon "#[fg=$color_white]îœ‘#[default]"
bar_sys_info="#{opsystem_icon} #[fg=$color_yellow]#{opsystem_version}"
# }}}

# status bar
set -g status-left "$bar_session"
set -g status-right "#{prefix_highlight} $bar_zoom_flag $bar_network $bar_sysstat $bar_date $bar_sys_info #[default]"

# }}}

# }}}

# run all plugins 
run '~/.tmux/plugins/tpm/tpm'
